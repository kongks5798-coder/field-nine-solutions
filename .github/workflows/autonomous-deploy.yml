name: NEXUS Autonomous Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deploy target'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - frontend
          - backend

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================
  # PHASE 1: Validation & Build
  # ============================================
  validate:
    name: Validate & Build
    runs-on: ubuntu-latest
    outputs:
      should_deploy_frontend: ${{ steps.changes.outputs.frontend }}
      should_deploy_backend: ${{ steps.changes.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect Changes
        id: changes
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(app|components|lib|src)/'; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(scripts|ai_engine|python_backend)/.*\.py$'; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Type Check
        run: npx tsc --noEmit
        continue-on-error: true

      - name: Build Test
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

  # ============================================
  # PHASE 2: Deploy Frontend to Vercel
  # ============================================
  deploy-frontend:
    name: Deploy Frontend (Vercel)
    runs-on: ubuntu-latest
    needs: validate
    if: |
      always() &&
      (needs.validate.outputs.should_deploy_frontend == 'true' ||
       github.event.inputs.deploy_target == 'all' ||
       github.event.inputs.deploy_target == 'frontend')
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel Production
        uses: amondnet/vercel-action@v25
        id: vercel
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

      - name: Verify Deployment
        run: |
          echo "Deployed to: ${{ steps.vercel.outputs.preview-url }}"
          sleep 10
          curl -sf "${{ steps.vercel.outputs.preview-url }}/api/health" || echo "Health check pending..."

      - name: Notify Success
        if: success()
        run: |
          echo "Frontend deployed successfully!"

  # ============================================
  # PHASE 3: Sync Backend (PM2)
  # ============================================
  deploy-backend:
    name: Sync Backend (PM2)
    runs-on: ubuntu-latest
    needs: validate
    if: |
      always() &&
      (needs.validate.outputs.should_deploy_backend == 'true' ||
       github.event.inputs.deploy_target == 'all' ||
       github.event.inputs.deploy_target == 'backend')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate Python Scripts
        run: |
          pip install flake8
          flake8 scripts/*.py --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Create Deployment Package
        run: |
          mkdir -p deploy-package
          cp -r scripts/*.py deploy-package/
          cp -r ai_engine/*.py deploy-package/ 2>/dev/null || true
          echo "${{ github.sha }}" > deploy-package/VERSION
          tar -czvf backend-${{ github.sha }}.tar.gz deploy-package/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-package
          path: backend-${{ github.sha }}.tar.gz
          retention-days: 7

      # Server Sync via SSH (if configured)
      - name: Check SSH Configuration
        id: check-ssh
        run: |
          if [ -n "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "SSH not configured - skipping server sync"
          fi

      - name: Sync to Server
        if: steps.check-ssh.outputs.configured == 'true'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ~/field-nine-solutions
            git pull origin main
            pm2 restart fieldnine-revenue || pm2 start ecosystem.config.js
            pm2 restart fieldnine-health || true
            pm2 save
            echo "Server sync completed at $(date)"

  # ============================================
  # PHASE 4: Health Check & Verification
  # ============================================
  health-check:
    name: System Health Verification
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always()
    steps:
      - name: Check Frontend Health
        id: frontend-health
        run: |
          FRONTEND_URL="${{ secrets.HEALTH_FRONTEND_URL || 'https://field-nine.vercel.app' }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi
          echo "Frontend: $HTTP_CODE"

      - name: Check Supabase Connection
        id: supabase-health
        run: |
          SUPABASE_URL="${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}"
          if [ -n "$SUPABASE_URL" ]; then
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$SUPABASE_URL/rest/v1/" -H "apikey: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" || echo "000")
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "401" ]; then
              echo "status=healthy" >> $GITHUB_OUTPUT
            else
              echo "status=unhealthy" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=not-configured" >> $GITHUB_OUTPUT
          fi

      - name: Generate Health Report
        run: |
          echo "## NEXUS System Health Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ steps.frontend-health.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase | ${{ steps.supabase-health.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # PHASE 5: Rollback on Failure
  # ============================================
  rollback:
    name: Auto Rollback
    runs-on: ubuntu-latest
    needs: [health-check]
    if: failure() && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Trigger Rollback
        run: |
          echo "Health check failed. Initiating rollback..."
          PREV_SHA=$(git rev-parse HEAD~1)
          echo "Rolling back to: $PREV_SHA"
          # Rollback logic would go here

      - name: Notify Failure
        run: |
          echo "::error::Deployment failed and rollback initiated"

  # ============================================
  # PHASE 6: Notifications
  # ============================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend, health-check]
    if: always()
    steps:
      - name: Determine Status
        id: status
        run: |
          if [ "${{ needs.health-check.result }}" = "success" ]; then
            echo "emoji=:white_check_mark:" >> $GITHUB_OUTPUT
            echo "status=SUCCESS" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "emoji=:x:" >> $GITHUB_OUTPUT
            echo "status=FAILED" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack Notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"${{ steps.status.outputs.color }}\",
                \"title\": \"${{ steps.status.outputs.emoji }} NEXUS Deploy: ${{ steps.status.outputs.status }}\",
                \"fields\": [
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"Commit\", \"value\": \"\`${{ github.sha }}\`\", \"short\": true},
                  {\"title\": \"Actor\", \"value\": \"${{ github.actor }}\", \"short\": true}
                ],
                \"footer\": \"NEXUS Autonomous Deploy\",
                \"ts\": $(date +%s)
              }]
            }" || echo "Slack notification failed (webhook not configured)"

      - name: Create GitHub Summary
        run: |
          echo "## ${{ steps.status.outputs.emoji }} Deployment ${{ steps.status.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ needs.health-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
