services:
  nextjs_app:
    container_name: nextjs_app
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    networks:
      - fieldnine_net
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    restart: always

  neural_nine_ai:
    container_name: neural_nine_ai
    build:
      context: ./ai_engine
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    networks:
      - fieldnine_net
    environment:
      - PYTHONUNBUFFERED=1
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8001/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: always

  fieldnine_tunnel:
    container_name: fieldnine_tunnel
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    depends_on:
      nextjs_app:
        condition: service_healthy
      neural_nine_ai:
        condition: service_healthy
    networks:
      - fieldnine_net
    restart: always

networks:
  fieldnine_net:
    name: fieldnine_net